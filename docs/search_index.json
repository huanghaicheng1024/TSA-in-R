[["index.html", "TSA in R 学习笔记 背景", " TSA in R 学习笔记 Huang 2020-11-27 背景 开始正式学习《时间序列分析及应用 R语言》(Time Series Analysis with Applications in R)。Joanthan D.Cryer &amp; Kung-Sik Chan 著，潘红宇等译。 贴个豆瓣链接 理论部分大多是纸质笔记，这里主要记录一下R语言的的实现。 准备：安装TSA包。 2020-11-18 "],["arma-plot.html", "1 ARMA模型的一些图像 1.1 模拟ARIMA 1.2 MA(q)过程 1.3 AR(p)过程", " 1 ARMA模型的一些图像 library(TSA) set.seed(1014) 1.1 模拟ARIMA 可以使用R自带的函数arima.sim来模拟生成ARIMA模型数据。 例如AR(1): \\[ Y_t = 0.7Y_{t-1}+e_t \\] y = arima.sim(model=list(ar=c(0.7)), n=100, sd=0.2) plot(y,type=&quot;o&quot;,cex=0.7) 1.2 MA(q)过程 \\[ Y_t = e_t-\\theta_1e_{t-1}-\\theta_2e_{t-2}-\\cdots-\\theta_qe_{t-q} \\] 注意：这里的表达式每个\\(\\theta\\)前面都是负号，但在R里面的系数指的是 \\(-\\theta\\)。 1.2.1 MA(1) 模型表达： \\[ Y_t = e_t-\\theta e_{t-1} \\] 统计特性： \\[ \\gamma_0=\\sigma_e^2(1+\\theta^2),\\quad \\gamma_1 = -\\theta\\sigma_e^2,\\quad \\gamma_k=0(k\\ge2) \\] \\[ \\rho_1=(-\\theta)/(1+\\theta^2),\\quad \\rho_k=0(k\\ge2) \\] 不同\\(\\theta\\)下MA(1)的一阶滞后自相关函数： theta &lt;- seq(-1,1,0.1) rho &lt;- (-theta)/(1+theta^2) plot(theta,rho,type = &quot;l&quot;) 图1.1: 不同theta下MA(1)的一阶滞后自相关函数 1.2.1.1 举例1 \\[ Y_t = e_t+0.9 e_{t-1} \\] 这里的 \\(\\theta=-0.9\\)。 模拟时间序列图： y = arima.sim(model=list(ma=c(0.9)), n=150, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图1.2: MA(1)例1模拟时间序列图 由图1.1，当\\(\\theta\\)接近-1，一阶自相关系数\\(\\rho_1\\)接近0.5，表示存在中等强度的正相关，如果一个观测值高于平均值，那么下一个观测值一般也会高于平均值，图形随时间变化比较平缓，只是偶尔有比较大的波动。 滞后散点图： opar &lt;- par(no.readonly = T) par(mfrow=c(1,2)) plot(zlag(y),y,ylab=expression(Y[t]),xlab=expression(Y[t-1]), type=&quot;p&quot;,main=&quot;一阶滞后散点图&quot;) plot(zlag(y,2),y,ylab=expression(Y[t]),xlab=expression(Y[t-2]), type=&quot;p&quot;,main=&quot;二阶滞后散点图&quot;) 左图相关性明显，右图相关性不明显。即一阶滞后自相关明显，二阶滞后自相关不明显，与前面提到的统计特性一致。 1.2.1.2 举例2 如果说图1.2的“平缓性”不明显，那我们就来个对比伤害吧。 \\[ Y_t = e_t-0.9 e_{t-1} \\] 这里的 \\(\\theta=0.9\\)。 模拟时间序列图： y = arima.sim(model=list(ma=c(-0.9)), n=150, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图1.3: MA(1)例2模拟时间序列图 由图1.1，当\\(\\theta\\)接近1，一阶自相关系数\\(\\rho_1\\)接近-0.5，表示存在中等强度的负相关，如果一个观测值高于平均值，那么下一个观测值一般会低于平均值，图形随时间变化呈锯齿状，特别是和图1.2相比。 滞后散点图： opar &lt;- par(no.readonly = T) par(mfrow=c(1,2)) plot(zlag(y),y,ylab=expression(Y[t]),xlab=expression(Y[t-1]), type=&quot;p&quot;,main=&quot;一阶滞后散点图&quot;) plot(zlag(y,2),y,ylab=expression(Y[t]),xlab=expression(Y[t-2]), type=&quot;p&quot;,main=&quot;二阶滞后散点图&quot;) 左图相关性明显，右图相关性不明显。即一阶滞后自相关明显，二阶滞后自相关不明显，与前面提到的统计特性一致。 1.2.2 MA(2) 模型表达： \\[ Y_t = e_t-\\theta_1e_{t-1}-\\theta_2e_{t-2} \\] 统计特性： \\[ \\gamma_0=\\sigma_e^2(1+\\theta_1^2+\\theta_2^2),\\quad \\gamma_1 = (-\\theta+\\theta_1\\theta_2)\\sigma_e^2,\\quad \\gamma_2=-\\theta_2\\sigma^2_e \\] \\[ \\rho_1=\\frac{-\\theta_1+\\theta_1\\theta_2}{1+\\theta_1^2+\\theta_2^2},\\quad \\rho_k=\\frac{-\\theta_2}{1+\\theta_1^2+\\theta_2^2},\\quad \\rho_k=0(k\\ge3) \\] 1.2.2.1 举例1 \\[ Y_t = e_t-e_{t-1}+0.6e_{t-2} \\] 这里的 \\(\\theta_1=1,\\theta_2=-0.6\\)。从而可以计算 \\(\\rho_1=-0.678,\\rho_2=0.254\\)。 模拟时间序列图： y = arima.sim(model=list(ma=c(-1,0.6)), n=150, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图1.4: MA(2)例1模拟时间序列图 一阶滞后比较强的负自相关，导致了图像呈现比较明显的锯齿状，围绕均值周围震荡。 滞后散点图： opar &lt;- par(no.readonly = T) par(mfrow=c(2,2)) plot(zlag(y),y,ylab=expression(Y[t]),xlab=expression(Y[t-1]), type=&quot;p&quot;,main=&quot;一阶滞后散点图&quot;) plot(zlag(y,2),y,ylab=expression(Y[t]),xlab=expression(Y[t-2]), type=&quot;p&quot;,main=&quot;二阶滞后散点图&quot;) plot(zlag(y,3),y,ylab=expression(Y[t]),xlab=expression(Y[t-3]), type=&quot;p&quot;,main=&quot;三阶滞后散点图&quot;) par(opar) 与计算得到的\\(\\rho_k\\)基本一致。 1.3 AR(p)过程 \\[ Y_t = \\phi_1Y_{t-1}+\\phi_2Y_{t-2}+\\cdots+\\phi_pY_{t-p}+e_t \\] 1.3.1 AR(1) 模型表达： \\[ Y_t = \\phi Y_{t-1}+e_t \\] 统计特性： \\[ \\gamma_0=\\frac{\\sigma_e^2}{1-\\phi^2},\\quad \\gamma_k=\\phi\\gamma_{k-1}(k\\ge1) \\] \\[ \\rho_k=\\phi^k(k\\ge1) \\] 不同\\(\\phi\\)下AR(1)的自相关函数： opar &lt;- par(no.readonly = T) par(mfrow=c(2,2)) p &lt;- c(0.9,0.4,-0.8,-0.5) k &lt;- seq(1,15,1) for(i in p) { m &lt;- bquote(phi~&quot;=&quot;~.(i)) # 将数学符号跟变量结合在一起 y = i^k plot(k,y,xlab = &quot;滞后&quot;,ylab = &quot;自相关函数&quot;, main = m,type=&quot;h&quot;) points(k,y,pch=20) abline(h = 0) } par(opar) 图1.5: 不同phi下AR(1)的自相关函数 由于\\(|\\phi|&lt;1\\)（平稳性），所以随着滞后长度k的增长，自相关系数的绝对值呈指数递减。当\\(\\phi&gt;0\\)，自相关系数均大于0，当\\(\\phi&lt;0\\)，自相关系数正负交错。 当\\(\\phi\\)在\\(\\pm1\\)附近，指数递减得很慢，远离\\(\\pm1\\)时会指数递减得很快。所以当\\(\\phi\\)在\\(\\pm1\\)附近时，强相关性将会持续很多期。如果\\(\\phi&gt;0\\)，序列会相对平滑（可能还会看起来像是有趋势），如果\\(\\phi&lt;0\\)，序列呈锯齿状。 关于上图中将数学符号跟变量结合在一起的做法，详见 https://blog.csdn.net/weixin_41929524/article/details/103610743, https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r 1.3.1.1 举例1 \\[ Y_t = 0.9Y_{t-1}+e_t \\] 这里 \\(\\phi=0.9\\)。 模拟时间序列图： y = arima.sim(model=list(ar=c(0.9)), n=150, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图1.6: AR(1)例1模拟时间序列图 由图1.6可以看到，图像比较平滑，看起来像是存在某种趋势（这当然是不存在的，均值恒为0），这是因为时间序列由于多期的强相关性而存在大量惯性变化。 1.3.1.2 举例2 \\[ Y_t = -0.5Y_{t-1}+e_t \\] 这里 \\(\\phi=-0.5\\)。 模拟时间序列图： y = arima.sim(model=list(ar=c(-0.5)), n=150, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图1.7: AR(1)例2模拟时间序列图 这个锯齿状就比较好理解了，由于自相关系数的正负交替指数递减，并且先负后正。 1.3.2 AR(2) 模型表达： \\[ Y_t = \\phi_1 Y_{t-1}+\\phi_2 Y_{t-2}+e_t \\] 统计特性： 由Yule-Walker方程 \\[ \\rho_k = \\phi_1\\rho_{k-1}+\\phi_2\\rho_{k-2},\\quad k\\ge1 \\] 导出： \\[ \\rho_1=\\frac{\\phi_1}{1-\\phi_2},\\quad \\rho_2=\\frac{\\phi_2(1-\\phi_2)+\\phi_1^2}{1-\\phi_2} \\] 不同\\(\\phi_1,\\phi_2\\)下AR(1)的自相关函数： opar &lt;- par(no.readonly = T) par(mfrow=c(2,2)) p &lt;- c(0.5,0.25,1.0,-0.25,1.5,-0.75,1.0,-0.6) for(i in 1:4) { # 将数学符号跟变量结合在一起 m &lt;- bquote(phi[1]~&quot;=&quot;~.(p[2*i-1])~phi[2]~&quot;=&quot;~.(p[2*i])) # 生成理论自相关函数 y &lt;- ARMAacf(ar = c(p[2*i-1],p[2*i]),lag.max = 12)[-1] plot(y,xlab = &quot;滞后&quot;,ylab = &quot;自相关函数&quot;, main = m,type=&quot;h&quot;) points(y,pch=20) abline(h = 0) } par(opar) 图1.8: 不同phi下AR(2)的自相关函数 上面所表示的AR(2)模型均满足平稳性: \\[ \\phi_1+\\phi_2&lt;1,\\quad \\phi_2-\\phi_1&lt;1,\\quad |\\phi_2|&lt;1 \\] 类似于图1.5，在实数特征根（\\(\\phi^2_1+4\\phi_2\\ge0\\)）下图像依旧是呈指数递减，在复数特征根下图像呈阻尼正弦波动曲线。 图1.5采用自相关系数的具体公式进行计算绘制，经书本提醒，图1.8使用函数ARMAacf函数计算理论自相关函数。 1.3.2.1 举例1 \\[ Y_t = 0.5 Y_{t-1}+0.25 Y_{t-2}+e_t \\] 这里 \\(\\phi_1=0.5,\\phi_2=0.25\\)。 模拟时间序列图： y = arima.sim(model=list(ar=c(0.5,0.25)), n=150, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图1.9: AR(2)例1模拟时间序列图 与图像1.6对比一下。 1.3.2.2 举例2 \\[ Y_t = 1.5 Y_{t-1}-0.75 Y_{t-2}+e_t \\] 这里 \\(\\phi_1=1.5,\\phi_2=-0.75\\)。 模拟时间序列图： y = arima.sim(model=list(ar=c(1.5,-0.75)), n=200, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图1.10: AR(2)例2模拟时间序列图 "],["arima-plot.html", "2 ARIMA模型的一些图像 2.1 IMA(d,q)过程 2.2 ARI(p,d)过程 2.3 一般ARIMA过程", " 2 ARIMA模型的一些图像 library(TSA) set.seed(1014) 2.1 IMA(d,q)过程 2.1.1 IMA(1,1) 模型表达： \\[ W_t = Y_t-Y_{t-1},\\quad W_t=e_t-\\theta e_{t-1} \\] 也即是 \\[ Y_t=Y_{t-1}+e_t-\\theta e_{t-1} \\] 统计特性： \\[ \\mathrm{Var}(Y_t) = [1+\\theta^2+(1-\\theta)^2(t+m)]\\sigma^2_e \\] 其中 \\(t=-m\\) 为序列的首次观测时间。上式表示方差会随着时间无限增大。 对于较大的 \\(m\\) 以及中等大小的 \\(k\\)： \\[ \\mathrm{Corr}(Y_t,Y_{t-k})\\approx1 \\] 上式表示 \\(Y_t,Y_{t-k}\\) 呈高度正相关。 2.1.1.1 举例1 \\[ Y_t=Y_{t-1}+e_t-0.8 e_{t-1} \\] 模拟时间序列图： y = arima.sim(model=list(order=c(0,1,1),ma=c(-0.8)), n=200, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图2.1: IMA(1,1)例1模拟时间序列图 因为方差的逐渐增大以及邻近相关系数的强相关性导致的图像像是有一定的趋势。 一次差分之后可以得到： plot(diff(y),type=&quot;o&quot;,cex=0.7,ylab=&quot;一次差分&quot;) 与图1.3非常地类似。 2.1.2 IMA(2,2) 模型表达： \\[ W_t = Y_t-2Y_{t-1}+Y_{t-2},\\quad W_t=e_t-\\theta_1 e_{t-1}-\\theta_2e_{t-2} \\] 也即是 \\[ Y_t=2Y_{t-1}-Y_{t-2}+e_t-\\theta_1 e_{t-1}-\\theta_2e_{t-2} \\] 统计特性： 类似于IMA(1,1)，\\(Y_t\\) 的方差会随着时间迅速无限增长，对于所有中等大小的 \\(k\\) ，\\(\\mathrm{Corr}(Y_t,Y_{t-k})\\approx1\\)。 2.1.2.1 举例1 \\[ Y_t=2Y_{t-1}-Y_{t-2}+e_t-e_{t-1}+0.6e_{t-2} \\] 模拟时间序列图： y = arima.sim(model=list(order=c(0,2,2),ma=c(-1,0.6)), n=200, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图2.2: IMA(2,2)例1模拟时间序列图 图像非常地平滑！同样也是由于方差的逐渐增大以及邻近相关系数的强相关性所导致。 一次差分： plot(diff(y),type=&quot;o&quot;,cex=0.7,ylab=&quot;一次差分&quot;) 二次差分： plot(diff(y,differences = 2),type=&quot;o&quot;,cex=0.7,ylab=&quot;二次差分&quot;) 这是平稳的MA(2)序列，与图1.4比较。 2.2 ARI(p,d)过程 2.2.1 ARI(1,1) 模型表达： \\[ W_t = Y_t-Y_{t-1},\\quad W_t = \\phi W_{t-1}+e_t \\] 也即是 \\[ Y_t = (1+\\phi)Y_{t-1}-\\phi Y_{t-2}+e_t \\] 2.2.1.1 举例1 \\[ Y_t = (1+0.8)Y_{t-1}-0.8 Y_{t-2}+e_t \\] 模拟时间序列图： y = arima.sim(model=list(order=c(1,1,0),ar=c(0.8)), n=200, sd=1) plot(y,type=&quot;o&quot;,cex=0.7) 图2.3: ARI(1,1)例1模拟时间序列图 同样是非常地平滑。 一次差分： plot(diff(y),type=&quot;o&quot;,cex=0.7,ylab=&quot;一次差分&quot;) 这是一个稳定的AR(1)序列。 2.3 一般ARIMA过程 data(&quot;oil.price&quot;) plot(oil.price,ylab=&quot;每桶价格&quot;) 图2.4: 原油月度价格：1986.1-2006.1 作对数差分变换： plot(diff(log(oil.price)), main=&quot;石油价格序列取对数后的差分序列图&quot;) 看起来比之前平稳多了。 data(&quot;electricity&quot;) plot(electricity) 图2.5: 美国月度发电量 作对数差分变换： plot(diff(log(electricity)), main=&quot;发电量取对数后的差分序列图&quot;) "],["model-recognition.html", "3 模型识别 3.1 主要方法 3.2 实践操作 3.3 非平稳性模型", " 3 模型识别 本章主要学习，对于给定的时间序列，如何选取适当的\\(p,d,q\\)，从而建立\\(ARIMA(p,d,q)\\)模型。 library(TSA) set.seed(1014) 3.1 主要方法 利用样本自相关函数估计\\(MA(q)\\)模型的自相关函数，再利用模型自相关函数的截尾性估计\\(q\\) 利用样本偏自相关函数估计\\(AR(p)\\)模型的偏自相关函数，再利用模型偏自相关函数的截尾性估计\\(p\\) 利用拓展的自相关系数估计\\(ARMA(p,q)\\)模型的\\(p,q\\) 3.2 实践操作 3.2.1 例1 理论模型\\(MA(1)\\)： \\[ Y_t = e_t-0.9e_{t-1} \\] 时间序列数据： eg1 &lt;- arima.sim(model = list(ma=-0.9),n=200,sd=1) 下面我们开始模型识别。 先绘制样本自相关函数图： acf(eg1) 利用函数acf绘制样本自相关图。上下两条虚线表示，自相关系数是否显著为0的临界值。此时的临界值是基于白噪声过程中的近似大样本标准误差，即\\(1/\\sqrt{n}\\)。 可以看到滞后1阶ACF值显著不为0，滞后7，8阶稍微超过临界值。可以考虑一下\\(MA(q)\\)模型。 修正一些ACF临界值： # 加入ci.type=&quot;ma&quot;，标准临界值是根据ma模型样本自相关系数的近似正体分布绘制的 acf(eg1,ci.type=&quot;ma&quot;) 可以看到，此时只有滞后1阶ACF显著不为0，意味着我们可以考虑为这个序列拟合\\(MA(1)\\)模型。 3.2.2 例2 理论模型\\(MA(2)\\)： \\[ Y_t = e_t-e_{t-1}+0.6e_{t-2} \\] 时间序列数据： eg2 &lt;- arima.sim(model = list(ma=c(-1,0.6)),n=200,sd=1) 下面我们开始模型识别。 先绘制样本自相关函数图： acf(eg2) 可以看到比较明显的滞后截尾性，滞后1，2阶ACF值显著不为0，滞后7阶稍微超过临界值。可以考虑一下\\(MA(q)\\)模型。 修正一下ACF临界值： acf(eg2,ci.type=&quot;ma&quot;) 可以看到，此时只有滞后1，2阶ACF显著不为0，意味着我们可以考虑为这个序列拟合\\(MA(2)\\)模型。 3.2.3 例3 理论模型\\(AR(1)\\)： \\[ Y_t = 0.9Y_{t-1}+e_t \\] 时间序列数据： eg3 &lt;- arima.sim(model = list(ar=0.9),n=200,sd=1) 下面我们开始模型识别。 先绘制样本自相关函数图： acf(eg3) 与理论图像1.5不太一致，样本ACF更像是线性递减而不是指数递减，并且不是一直保持大于0。但这并不影响我们去考虑\\(AR(p)\\)模型。 观测样本偏自相关系数PACF图像： pacf(eg3) 可以看到，此时滞后1阶PACF显著不为0，滞后3阶稍微超过临界值，意味着我们可以考虑为这个序列拟合\\(AR(1)\\)模型，但在模型诊断时需要进一步研究滞后3阶的显著性。 3.2.4 例4 理论模型\\(AR(2)\\)： \\[ Y_t = 1.5Y_{t-1}-0.75Y_{t-2}+e_t \\] 时间序列数据： eg4 &lt;- arima.sim(model = list(ar=c(1.5,-0.75)),n=200,sd=1) 下面我们开始模型识别。 先绘制样本自相关函数图： acf(eg4) 图像呈阻尼正弦波动曲线，可以考虑一下\\(AR(p)\\)模型。 观测样本偏自相关系数PACF图像： pacf(eg4) 可以看到，此时只有滞后1，2阶PACF显著不为0，意味着我们可以考虑为这个序列拟合\\(AR(2)\\)模型。 3.2.5 例5 理论模型\\(ARMA(1,1)\\)： \\[ Y_t = 0.6Y_{t-1}+e_t+0.3e_{t-1} \\] 时间序列数据： eg5 &lt;- arima.sim(model = list(ar=0.6,ma=0.3),n=100,sd=1) 下面我们开始模型识别。 先绘制样本自相关函数图： acf(eg5) 样本PACF： pacf(eg5) 综上，看起来我们应该为序列拟合\\(AR(1)\\)模型。 但是，我们看一下拓展的自相关系数EACF： eacf(eg5) #&gt; AR/MA #&gt; 0 1 2 3 4 5 6 7 8 9 10 11 12 13 #&gt; 0 x x o o o o o o o o o o o o #&gt; 1 x o o o o o o o o o o o o o #&gt; 2 x x o o o o o o o o o o o o #&gt; 3 x o o o o o o o o o o o o o #&gt; 4 x x o x o o o o o o o o o o #&gt; 5 x o x x o o o o o o o o o o #&gt; 6 x x x o o o o o o o o o o o #&gt; 7 x x o o o o o o o o o o o o 这表示我们应该为该序列拟合\\(ARMA(1,1)\\)模型。 接下来我们看一下前4个例子的EACF： eacf(eg1) #&gt; AR/MA #&gt; 0 1 2 3 4 5 6 7 8 9 10 11 12 13 #&gt; 0 x o o o o o x x o o o o o o #&gt; 1 x x o o o o o x o o o o o o #&gt; 2 x x o o o o o x o o o o o o #&gt; 3 x x o o o o o x o o o o o o #&gt; 4 x x x o x o o x o o o o o o #&gt; 5 x o o o x o o x o o o o o o #&gt; 6 x x x x x x o x o o o o o o #&gt; 7 x x o o o x o o o o o o o o eacf(eg2) #&gt; AR/MA #&gt; 0 1 2 3 4 5 6 7 8 9 10 11 12 13 #&gt; 0 x x o o o o x o o o o o o o #&gt; 1 x x x o o o o o o o o o o o #&gt; 2 x x o o o o o o o o o o o o #&gt; 3 x x x x x o o o o o o o o o #&gt; 4 x o x x x o o o o o o o o o #&gt; 5 x x x x x o o o o o o o o o #&gt; 6 o x x o o o o o o o o o o o #&gt; 7 x o o o o o o o o o o o o o eacf(eg3) #&gt; AR/MA #&gt; 0 1 2 3 4 5 6 7 8 9 10 11 12 13 #&gt; 0 x x x x x x x o o o o o o o #&gt; 1 o x o o o o o o o o o o o o #&gt; 2 x x o o o o o o o o o o o o #&gt; 3 o x o o o o o o o o o o o o #&gt; 4 x o x o o o o o o o o o o o #&gt; 5 x o x o o o o o o o o o o o #&gt; 6 x x x x o o o o o o o o o o #&gt; 7 x o x x o x o o o o o o o o eacf(eg4) #&gt; AR/MA #&gt; 0 1 2 3 4 5 6 7 8 9 10 11 12 13 #&gt; 0 x x o x x x x o o x x x o o #&gt; 1 x x o x x x x o x x x x o o #&gt; 2 o o o o o x o o o o o o o o #&gt; 3 x o o o o x o o o o o x o o #&gt; 4 x x o o o o o o o o o x o o #&gt; 5 x x o o o o o o o o o x o o #&gt; 6 x x o o o o o o o o o o o o #&gt; 7 x x o o x o o o o o o o o o 均支持我们之前的模型假设。 3.3 非平稳性模型 "]]
